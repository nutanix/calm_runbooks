{"status":{},"spec":{"name":"Manage VPC","description":"","resources":{"runbook":{"name":"3c8eed1d_runbook","description":"","task_definition_list":[{"type":"DAG","name":"21662e24_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"Validate Parameters","kind":"app_task"},"to_task_reference":{"name":"VPC Operations","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"Validate Parameters","kind":"app_task"},{"name":"VPC Operations","kind":"app_task"}],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"SET_VARIABLE","name":"Validate Parameters","description":"","attrs":{"type":"","script":"import requests\nfrom requests.auth import HTTPBasicAuth\n\nPC_IP =  \"@@{PC_IP}@@\"\npc_username = \"@@{prism_central_username}@@\"\npc_password = \"@@{prism_central_passwd}@@\"\n\ndef _build_url(scheme, resource_type, host=PC_IP, **params):\n    _base_url = \"\/api\/nutanix\/v3\"\n    url = \"{proto}:\/\/{host}\".format(proto=scheme, host=host)\n    port = params.get('nutanix_port', '9440')\n    if port:\n        url = url + \":{0}\".format(port) + _base_url\n    if resource_type.startswith(\"\/\"):\n        url += resource_type\n    else:\n        url += \"\/{0}\".format(resource_type)\n    return url\n  \ndef _get_vlan_details():\n    existing_subnet = \"@@{external_subnet_uuid}@@\"\n    if existing_subnet == \"NA\":\n        print(\"Input Error :- External Subnet UUID is mandatory parameter.\")\n        exit(1)\n    _url = _build_url(scheme=\"https\",\n                    resource_type=\"\/subnets\/%s\"%existing_subnet)\n    _data = requests.get(_url, auth=HTTPBasicAuth(pc_username, pc_password),verify=False)\n    if _data.ok:\n        if _data.json().get('state', _data.json()['status']['state']) != \"COMPLETE\":\n            print(\"Input Error :- Please Provide Valide External Subnet UUID\")\n            exit(1)      \n        return _data.json()['spec']['name']\n    else:\n        print(\"Input Error :- Please Provide Valide External Subnet UUID\")\n        print(_data.json().get(\"message_list\", _data.json()))\n        exit(1)\n\nif \"@@{operation}@@\" in [\"update\", \"delete\"]:\n    if \"@@{vpc_uuid}@@\" == \"NA\":\n        print(\"Input Error :- VPC UUID is mandatory for Update and Delete operations.\")\n        exit(1)\n\nvpc_items = {}\nif \"@@{operation}@@\" != \"delete\":\n    if \"@@{externally_routable_ip}@@\" == \"NA\":\n        external_ip = \"NA\"\n        prefix = 0\n    else:\n    \texternal_ip, prefix = \"@@{externally_routable_ip}@@\".split(\"\/\")\n    vpc_items =  {\n                    \"name\": \"@@{vpc_name}@@\",\n                    \"dns_servers\" : \"@@{dns_server}@@\",\n                    \"external_subnet_name\": _get_vlan_details(),\n                    \"external_subnet_uuid\" : \"@@{external_subnet_uuid}@@\",\n                    \"externally_routable_ip\": external_ip,\n                    \"externally_routable_ip_prefix\": int(prefix)\n                }\nprint(\"vpc_items={}\".format(vpc_items))","script_type":"static_py3","exit_status":[],"eval_scope":"local","eval_variables":["vpc_items"]},"child_tasks_local_reference_list":[],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"VPC Operations","description":"","attrs":{"type":"","script":"#script\n\nimport requests\nfrom requests.auth import HTTPBasicAuth\n\nPC_IP = \"@@{PC_IP}@@\"\npc_username = \"@@{prism_central_username}@@\"\npc_password = \"@@{prism_central_passwd}@@\"\n\ndef _build_url(scheme, resource_type, host=PC_IP, **params):\n    _base_url = \"\/api\/nutanix\/v3\"\n    url = \"{proto}:\/\/{host}\".format(proto=scheme, host=host)\n    port = params.get('nutanix_port', '9440')\n    if port:\n        url = url + \":{0}\".format(port) + _base_url\n    if resource_type.startswith(\"\/\"):\n        url += resource_type\n    else:\n        url += \"\/{0}\".format(resource_type)\n    return url\n\ndef _get_default_spec():\n    return(\n            {\n            \"api_version\": \"3.1.0\",\n            \"metadata\": {\"kind\": \"vpc\", \"categories\": {}},\n            \"spec\": {\n                \"name\": None,\n                \"resources\": {\n                    \"external_subnet_list\": []\n                    },\n                },\n            })\n\ndef create_vpc(**params):\n    payload = _get_default_spec()\n    if params['uuid'] != \"NA\":\n        payload[\"spec\"]['uuid'] = params['uuid']\n    payload[\"spec\"]['name'] = params['name']\n    if params.get(\"common_domain_name_server_ip_list\", \"NA\") != \"NA\":\n        payload[\"spec\"][\"resources\"][\"common_domain_name_server_ip_list\"] = \\\n                                params[\"common_domain_name_server_ip_list\"]\n    payload[\"spec\"][\"resources\"][\"external_subnet_list\"] = \\\n                                params[\"external_subnet_list\"]\n    if params.get(\"externally_routable_prefix_list\", \"NA\") != \"NA\":\n        payload[\"spec\"][\"resources\"][\"externally_routable_prefix_list\"] = \\\n                                params[\"externally_routable_prefix_list\"]\n    if \"@@{operation}@@\" == \"update\":\n        update_vpc(**payload[\"spec\"])\n    else:\n        url = _build_url(scheme=\"https\",\n                        resource_type=\"\/vpcs\")    \n        data = requests.post(url, json=payload,\n                         auth=HTTPBasicAuth(pc_username, pc_password ),\n                         timeout=None, verify=False)\n                         \n        if not data.ok:\n            print(\"Got Error ---> \",data.json().get('message_list', \n                                    data.json().get('error_detail', data.json())))\n            exit(1)\n        else:\n            task_uuid = wait_for_completion(data)\n            vpc = {\"vpc_name\": params['name'], \n                   \"vpc_uuid\":data.json()['metadata']['uuid']}\n            print(\"Please make a note of VPC Details for furure refrerence.\")\n            print(vpc)\n\ndef update_vpc(**payload):\n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/vpcs\/%s\"%\"@@{vpc_uuid}@@\")    \n    data = requests.get(url, auth=HTTPBasicAuth(pc_username, pc_password),\n                        timeout=None, verify=False)\n                         \n    if not data.ok:\n        print(\"Got Error ---> \",data.json().get('message_list', \n                                data.json().get('error_detail', data.json())))\n        exit(1)\n        \n    _spec = data.json()    \n    for x in [\"last_update_time\", \"creation_time\", \"spec_hash\", \"categories_mapping\", \"owner_reference\", \"categories\"]:\n        del _spec[\"metadata\"][x]\n        \n    del _spec[\"status\"]\n    del _spec[\"spec\"]\n    \n    _spec[\"spec\"] = payload\n    \n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/vpcs\/%s\"%\"@@{vpc_uuid}@@\")    \n    data = requests.put(url, json=_spec,\n                        auth=HTTPBasicAuth(pc_username, pc_password),\n                        timeout=None, verify=False)\n                         \n    if not data.ok:\n        print(\"Got Error ---> \",data.json().get('message_list', \n                                data.json().get('error_detail', data.json())))\n        exit(1)\n    else:\n        task_uuid = wait_for_completion(data)\n        print(\"%s VPC updated successfully.\"%\"@@{vpc_name}@@\")\n        \ndef delete_vpc(**params):\n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/vpcs\/%s\"%params[\"uuid\"])\n    \n    data = requests.delete(url,auth=HTTPBasicAuth(pc_username, pc_password),\n                           timeout=None, verify=False)\n                         \n    if not data.ok:\n        print(\"Got Error ---> \",data.json().get('message_list', \n                                data.json().get('error_detail', data.json())))\n        exit(1)\n    else:\n        task_uuid = wait_for_completion(data)\n        print(\"%s VPC Deleted successfully.\"%params[\"name\"])\n        \ndef wait_for_completion(data):\n    if data.status_code in [200, 202]:\n        state = data.json()['status'].get('state')\n        if state == \"DELETE_PENDING\":\n            state = \"PENDING\"\n        while state == \"PENDING\":\n            _uuid = data.json()['status']['execution_context']['task_uuid']\n            url = _build_url(scheme=\"https\",\n                             resource_type=\"\/tasks\/%s\"%_uuid)\n            responce = requests.get(url, auth=HTTPBasicAuth(pc_username, pc_password), \n                                    verify=False)\n            if responce.json()['status'] in ['PENDING', 'RUNNING', 'QUEUED', 'DELETE_PENDING']:\n                state = 'PENDING'\n                sleep(5)                \n            elif responce.json()['status'] == 'FAILED':\n                print(\"Got Error ---> \",responce.json().get('message_list', \n                                        responce.json().get('error_detail', responce.json())))\n                state = 'FAILED'\n                exit(1)\n            else:\n                state = \"COMPLETE\"\n    else:\n        print(\"Got Error ---> \",data.json().get('message_list', \n                                data.json().get('error_detail', data.json())))\n        exit(1)\n    return data.json()['status']['execution_context']['task_uuid']\n    \ndef validate_params():\n    params = {}\n    params_dict = @@{vpc_items}@@\n    params['name'] = \"@@{vpc_name}@@\"\n    params['uuid'] = \"@@{vpc_uuid}@@\"\n    if \"@@{operation}@@\" == \"delete\":\n        delete_vpc(**params)\n    else:\n        print(\"##### {0} VPC {1} #####\".format(\"@@{operation}@@\", params['name']))\n        if params_dict.get(\"dns_servers\", \"NA\") != \"NA\":\n            params[\"common_domain_name_server_ip_list\"] = [{}]\n            params[\"common_domain_name_server_ip_list\"][0]['ip'] = \\\n                                            params_dict.get('dns_servers', 'None')\n        params[\"external_subnet_list\"] = [{}]\n        if params_dict.get(\"externally_routable_ip\", \"NA\") != \"NA\":\n            params[\"externally_routable_prefix_list\"] = [{}]\n            params[\"externally_routable_prefix_list\"][0][\"ip\"] = \\\n                                            params_dict[\"externally_routable_ip\"]\n            params[\"externally_routable_prefix_list\"][0][\"prefix_length\"] = \\\n                                            params_dict[\"externally_routable_ip_prefix\"]\n                                            \n        if params_dict.get(\"external_subnet_name\", \"NA\") != \"NA\":\n            params[\"external_subnet_list\"][0][\"external_subnet_reference\"] = {}\n            params[\"external_subnet_list\"][0][\"external_subnet_reference\"][\"kind\"] = \"subnet\"\n            params[\"external_subnet_list\"][0][\"external_subnet_reference\"][\"name\"] = \\\n                                            params_dict[\"external_subnet_name\"]\n            params[\"external_subnet_list\"][0][\"external_subnet_reference\"][\"uuid\"] = \\\n                                            params_dict[\"external_subnet_uuid\"]\n                                            \n        if params_dict.get(\"external_subnet_uuid\", \"NA\") != \"NA\":\n            params[\"external_subnet_list\"][0][\"external_subnet_reference\"][\"uuid\"] = \\\n                                                    params_dict['external_subnet_uuid']\n        create_vpc(**params)\n\nvalidate_params()","script_type":"static_py3","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"21662e24_dag","kind":"app_task"},"variable_list":[{"type":"LOCAL","name":"vpc_name","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"VPC Name","attrs":{"type":""},"editables":{"value":true},"value":"vpc_uat1"},{"type":"LOCAL","name":"operation","description":"","options":{"type":"PREDEFINED","choices":["create","update","delete"]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"Operation","attrs":{"type":"LOCAL"},"editables":{"value":true},"value":"create"},{"type":"LOCAL","name":"vpc_uuid","description":"# Required for Update and Delete Operations. Keep NA for Create Operation.","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"VPC UUID","attrs":{"type":""},"editables":{"value":true},"value":"NA"},{"type":"LOCAL","name":"external_subnet_uuid","description":"# Keep NA for Delete operation, Required for Create and Update.","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"External Subnet UUID","attrs":{"type":""},"editables":{"value":true},"value":"d929d23f-f15c-4ebb-a266-e174e2409ef4"},{"type":"LOCAL","name":"externally_routable_ip","description":"# Keep NA if not required.\nEx :- 10.10.10.0\/24","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"Externally Routable IP with prefix","attrs":{"type":""},"editables":{"value":true},"value":"10.20.50.0\/24"},{"type":"LOCAL","name":"dns_server","description":"# Keep NA if not required.\nEX:8.8.8.6","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"DNS Server","attrs":{"type":""},"editables":{"value":true},"value":"NA"},{"type":"LOCAL","name":"PC_IP","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"PC IP","attrs":{"type":""},"editables":{"value":true},"value":"10.44.76.167"},{"type":"SECRET","name":"prism_central_username","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"PC Username","attrs":{"type":"SECRET","is_secret_modified":false,"secret_reference":{}},"editables":{"value":true},"value":"rCzW4S3anbpq1esE5wwucNTwGv7odlwjzwGgGyQS1ZZsQvBtSw==:utf-8"},{"type":"SECRET","name":"prism_central_passwd","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"PC Password","attrs":{"type":"SECRET","is_secret_modified":false,"secret_reference":{}},"editables":{"value":true},"value":"LjqyyevSjCd+XpGw3L0t5zLlR8bNOnovzV6tF4i4FX4lSOecO3b9Z6GP4A==:utf-8"}]},"endpoint_definition_list":[],"credential_definition_list":[],"endpoints_information":[],"client_attrs":{}}},"api_version":"3.0","product_version":"4.0.0","metadata":{"last_update_time":"1739133569519644","creation_time":"1739133569519644","spec_version":0,"name":"Manage VPC","kind":"runbook"},"contains_secrets":true}
