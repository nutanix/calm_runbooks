{"status":{},"spec":{"name":"Floating IP Assignment","description":"","resources":{"runbook":{"name":"cb404d1c_runbook","description":"","task_definition_list":[{"type":"DAG","name":"10318349_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[{"name":"Create Floating IP","kind":"app_task"}],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Create Floating IP","description":"","attrs":{"type":"","script":"# script\nimport requests\nfrom requests.auth import HTTPBasicAuth\n\nPC_IP = \"@@{PC_IP}@@\"\npc_username = \"@@{prism_central_username}@@\"\npc_password = \"@@{prism_central_passwd}@@\"\n\ndef _build_url(scheme, resource_type, host=PC_IP, **params):\n    _base_url = \"\/api\/nutanix\/v3\"\n    url = \"{proto}:\/\/{host}\".format(proto=scheme, host=host)\n    port = params.get('nutanix_port', '9440')\n    if port:\n        url = url + \":{0}\".format(port) + _base_url\n    if resource_type.startswith(\"\/\"):\n        url += resource_type\n    else:\n        url += \"\/{0}\".format(resource_type)\n    return url\n\ndef _get_default_spec(external_subnet_uuid, **params):\n    return ({\n              \"spec\": {\n                \"description\": params.get('description', \"Floating IP for @@{vm_ip}@@\"),\n                \"resources\": {\n                  \"external_subnet_reference\": {\n                    \"kind\": \"subnet\",\n                    \"uuid\": external_subnet_uuid\n                  }\n                }\n              },\n              \"api_version\": \"3.1.0\",\n              \"metadata\": {\n                \"kind\": \"floating_ip\"\n                  }\n            })\n\ndef get_subnet_uuid(subnet):\n    url = _build_url(scheme=\"https\",resource_type=\"\/subnets\/list\")\n    data = requests.post(url, json={\"kind\":\"subnet\", \"filter\":\"name==%s\"%subnet},\n                         auth=HTTPBasicAuth(pc_username, pc_password),\n                         timeout=None, verify=False)\n    if data.ok:\n        if data.json()['metadata']['total_matches'] == 0:\n            print(\"%s not present on %s\"%(subnet, PC_IP))\n            exit(1)\n        elif data.json()['metadata']['total_matches'] > 1:\n            print(\"There are more than one subnets with name - %s on - %s\"%(subnet, PC_IP))\n            print(\"Please delete it manually before executing runbook.\")\n            exit(1)\n        else:\n            return data.json()['entities'][0]['metadata']['uuid']\n    else:\n        print(\"Error while fetching subnet details :- \",data.json().get('message_list',\n                                     data.json().get('error_detail', data.json())))\n        exit(1)\n        \ndef get_vpc_uuid(vpc):\n    url = _build_url(scheme=\"https\",resource_type=\"\/vpcs\/list\")\n    data = requests.post(url, json={\"kind\":\"vpc\", \"filter\":\"name==%s\"%vpc},\n                         auth=HTTPBasicAuth(pc_username, pc_password),\n                         timeout=None, verify=False)\n    if data.ok:\n        if data.json()['metadata']['total_matches'] == 0:\n            print(\"%s not present on %s\"%(vpc, PC_IP))\n            exit(1)\n        elif data.json()['metadata']['total_matches'] > 1:\n            print(\"There are more than one VPCs with name - %s on - %s\"%(vpc, PC_IP))\n            print(\"Please delete it manually before executing runbook.\")\n            exit(1)\n        else:\n            return data.json()['entities'][0]['metadata']['uuid']\n    else:\n        print(\"Error while fetching VPC details :- \",data.json().get('message_list',\n                                     data.json().get('error_detail', data.json())))\n        exit(1)\n        \ndef get_nic_uuid(vm_name):\n    url = _build_url(scheme=\"https\", resource_type=\"\/vms\/list\")\n    data = requests.post(url, json={\"kind\":\"vm\"},\n                        auth=HTTPBasicAuth(pc_username, pc_password), verify=False)\n    if data.ok:\n        if vm_name in str(data.json()):\n            for _vm in data.json()[\"entities\"]:\n              if _vm[\"spec\"][\"name\"] == vm_name:\n                  vm_uuid = _vm[\"metadata\"][\"uuid\"]\n        else:\n            print(\"%s VM not present on %s\"%(vm_name, PC_IP))\n            print(\"Please check provided VM details.\")\n            exit(1)\n    else:\n        print(\"Error while fetching VM details.\",data.json())\n        exit(1)\n        \n    payload = {\"entity_type\":\"virtual_nic\",\n               \"group_member_attributes\":[{\"attribute\":\"assigned_ipv4_addresses\"}],\n               \"group_member_count\":50,\n               \"group_member_offset\":0,\n               \"filter_criteria\":\"vm==%s\"%vm_uuid}\n    \n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/groups\")\n    data = requests.post(url, json=payload,\n                        auth=HTTPBasicAuth(pc_username, pc_password),\n                        timeout=None, verify=False)\n    \n    if data.ok:\n        return data.json()[\"group_results\"][0][\"entity_results\"][0][\"entity_id\"]\n    else:\n        print(\"Error while fetching NIC uuid.\",data.json())\n        exit(1)\n        \ndef generate_floating_ip(**params):\n    external_subnet_uuid = get_subnet_uuid(params[\"external_subnet\"])\n    print(\"======================================\")     \n    payload = _get_default_spec(external_subnet_uuid, **params)\n    \n    if \"IP\" in params.keys():\n        vpc_uuid = get_vpc_uuid(params[\"vpc_name\"])\n        payload[\"spec\"][\"resources\"][\"private_ip\"] = \"@@{vm_ip}@@\"\n        payload[\"spec\"][\"resources\"][\"vpc_reference\"] = {\n                                                         \"kind\":\"vpc\",\n                                                         \"uuid\":vpc_uuid\n                                                        }\n    elif \"VM_Name\" in params.keys():\n        nic_uuid = get_nic_uuid(params[\"VM_Name\"])\n        payload[\"spec\"][\"resources\"][\"vm_nic_reference\"] = {\n                                                            \"kind\": \"vm_nic\",\n                                                            \"uuid\":nic_uuid\n                                                           }\n    else:\n        print(\"Input Error :- User should provide VM IP in 'VM IP'\")\n        exit(1)\n        \n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/floating_ips\")\n    data = requests.post(url, json=payload,\n                        auth=HTTPBasicAuth(pc_username, pc_password),\n                        timeout=None, verify=False)\n    wait_for_completion(data)\n    print(\"floating_ip_details={}\".format({\"IP_uuid\": data.json()['metadata']['uuid']}))\n    \n    sleep(5)\n    _url = _build_url(scheme=\"https\",\n                     resource_type=\"\/floating_ips\/%s\"%(data.json()['metadata']['uuid']))\n    _data = requests.get(_url, auth=HTTPBasicAuth(pc_username, pc_password), verify=False)\n    if (_data.ok) and (\"status\" in _data.json()):\n        print(\"Floating IP assigned to '%s' is :- %s\"%(\"@@{vm_ip}@@\",\n                          _data.json()[\"status\"][\"resources\"][\"floating_ip\"]))\n    else:\n        print(\"Failed to fetch details of newly created floating IP.\")\n        print(\"Please check it manually.\")\n        exit(1)\n\ndef wait_for_completion(data):\n    if data.ok:\n        state = data.json()['status'].get('state')\n        while state == \"PENDING\":\n            _uuid = data.json()['status']['execution_context']['task_uuid']\n            url = _build_url(scheme=\"https\",\n                             resource_type=\"\/tasks\/%s\"%_uuid)\n            responce = requests.get(url, auth=HTTPBasicAuth(pc_username, pc_password), \n                                    verify=False)\n            if responce.json()['status'] in ['PENDING', 'RUNNING']:\n                state = 'PENDING'\n                sleep(5)                \n            elif responce.json()['status'] == 'FAILED':\n                print(\"Got error while generating floating IP ---> \",responce.json())\n                state = 'FAILED'\n                exit(1)\n            else:\n                state = 'SUCCESSED'\n    else:\n        state = data.json().get('state')\n        print(\"Got error while generating floating IP --->\",data.json())\n        exit(1)\n        \nparams = {\n              \"external_subnet\":\"@@{external_subnet_name}@@\"\n         }\n\nif \"@@{assignment_type}@@\" == \"IP\":\n    params[\"IP\"] = \"@@{vm_ip}@@\"\n    params[\"vpc_name\"] = \"@@{vpc_name}@@\"\n    if params[\"vpc_name\"].lower() in [\"\", \"na\", \"none\"]:\n        print(\"Input Error :- VPC Name is Mandatory for 'Floating IP Assignment Type = IP'.\")\n        exit(1)\n\nprint(\"##### Generating Floating IP #####\")\ngenerate_floating_ip(**params)","script_type":"static_py3","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"10318349_dag","kind":"app_task"},"variable_list":[{"type":"LOCAL","name":"assignment_type","description":"For IP - Need to provide IP address in Entity","options":{"type":"PREDEFINED","choices":["IP"]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"Floating IP Assignment Type","attrs":{"type":"LOCAL"},"editables":{"value":true},"value":"IP"},{"type":"LOCAL","name":"vm_ip","description":"For which floating IP is needed.","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"VM IP","attrs":{"type":""},"editables":{"value":true},"value":"10.20.10.5"},{"type":"LOCAL","name":"vpc_name","description":"Required only if \"Floating IP Assignment Type\" is \"IP\"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"VPC Name","attrs":{"type":""},"editables":{"value":true},"value":"uat1_VPC"},{"type":"LOCAL","name":"external_subnet_name","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"External Subnet Name","attrs":{"type":""},"editables":{"value":true},"value":"uat1_External_Subnet"},{"type":"LOCAL","name":"PC_IP","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"PC IP","attrs":{"type":""},"editables":{"value":true},"value":"10.44.76.167"},{"type":"SECRET","name":"prism_central_username","description":"","regex":{"value":"^.*$","should_validate":false},"options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"Prism Central Password","attrs":{"type":"SECRET","is_secret_modified":false,"secret_reference":{}},"editables":{"value":true},"value":"A6V4dsFCKXuJgyVbbqyC\/E4GZ6VFuhlb4PD1lEq4CaElIcJdtg==:utf-8"},{"type":"SECRET","name":"prism_central_passwd","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"Prism Central Password","attrs":{"type":"SECRET","is_secret_modified":false,"secret_reference":{}},"editables":{"value":true},"value":"L6caqbX1o6iDvHR2QGnY1nZ4cKzu4K1nu5lpA0wx6\/T1x+Mqhpl7HD40pw==:utf-8"}]},"endpoint_definition_list":[],"credential_definition_list":[],"endpoints_information":[],"client_attrs":{}}},"api_version":"3.0","product_version":"4.0.0","metadata":{"last_update_time":"1739133617673365","creation_time":"1739133617673365","spec_version":0,"name":"Floating IP Assignment","kind":"runbook"},"contains_secrets":true}
